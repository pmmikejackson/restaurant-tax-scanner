<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Restaurant Tax Scanner</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Texas Restaurant Tax Scanner</h1>
            <p>Identify all applicable taxes for your restaurant POS configuration</p>
        </div>

        <div class="content">
            <div class="location-section">
                <h2 class="section-title">
                    üìç Restaurant Location
                </h2>
                
                <div class="location-inputs">
                    <div class="input-group">
                        <label for="county">County</label>
                        <input type="text" id="county" list="county-list" placeholder="Type or select county..." autocomplete="off">
                        <datalist id="county-list">
                            <option value="anderson">Anderson County</option>
                            <option value="andrews">Andrews County</option>
                            <option value="angelina">Angelina County</option>
                            <option value="aransas">Aransas County</option>
                            <option value="archer">Archer County</option>
                            <option value="armstrong">Armstrong County</option>
                            <option value="atascosa">Atascosa County</option>
                            <option value="austin">Austin County</option>
                            <option value="bailey">Bailey County</option>
                            <option value="bandera">Bandera County</option>
                            <option value="bastrop">Bastrop County</option>
                            <option value="baylor">Baylor County</option>
                            <option value="bee">Bee County</option>
                            <option value="bell">Bell County</option>
                            <option value="bexar">Bexar County</option>
                            <option value="blanco">Blanco County</option>
                            <option value="borden">Borden County</option>
                            <option value="bosque">Bosque County</option>
                            <option value="bowie">Bowie County</option>
                            <option value="brazoria">Brazoria County</option>
                            <option value="brazos">Brazos County</option>
                            <option value="brewster">Brewster County</option>
                            <option value="briscoe">Briscoe County</option>
                            <option value="brown">Brown County</option>
                            <option value="burleson">Burleson County</option>
                            <option value="burnet">Burnet County</option>
                            <option value="caldwell">Caldwell County</option>
                            <option value="calhoun">Calhoun County</option>
                            <option value="callahan">Callahan County</option>
                            <option value="cameron">Cameron County</option>
                            <option value="camp">Camp County</option>
                            <option value="carson">Carson County</option>
                            <option value="cass">Cass County</option>
                            <option value="castro">Castro County</option>
                            <option value="chambers">Chambers County</option>
                            <option value="cherokee">Cherokee County</option>
                            <option value="childress">Childress County</option>
                            <option value="clay">Clay County</option>
                            <option value="cochran">Cochran County</option>
                            <option value="coke">Coke County</option>
                            <option value="coleman">Coleman County</option>
                            <option value="collin">Collin County</option>
                            <option value="collingsworth">Collingsworth County</option>
                            <option value="colorado">Colorado County</option>
                            <option value="comal">Comal County</option>
                            <option value="comanche">Comanche County</option>
                            <option value="concho">Concho County</option>
                            <option value="cooke">Cooke County</option>
                            <option value="coryell">Coryell County</option>
                            <option value="cottle">Cottle County</option>
                            <option value="crane">Crane County</option>
                            <option value="crockett">Crockett County</option>
                            <option value="crosby">Crosby County</option>
                            <option value="culberson">Culberson County</option>
                            <option value="dallam">Dallam County</option>
                            <option value="dallas">Dallas County</option>
                            <option value="dawson">Dawson County</option>
                            <option value="deaf-smith">Deaf Smith County</option>
                            <option value="delta">Delta County</option>
                            <option value="denton">Denton County</option>
                            <option value="dewitt">DeWitt County</option>
                            <option value="dickens">Dickens County</option>
                            <option value="donley">Donley County</option>
                            <option value="eastland">Eastland County</option>
                            <option value="ector">Ector County</option>
                            <option value="edwards">Edwards County</option>
                            <option value="el-paso">El Paso County</option>
                            <option value="ellis">Ellis County</option>
                            <option value="erath">Erath County</option>
                            <option value="falls">Falls County</option>
                            <option value="fannin">Fannin County</option>
                            <option value="fayette">Fayette County</option>
                            <option value="fisher">Fisher County</option>
                            <option value="floyd">Floyd County</option>
                            <option value="foard">Foard County</option>
                            <option value="fort-bend">Fort Bend County</option>
                            <option value="franklin">Franklin County</option>
                            <option value="freestone">Freestone County</option>
                            <option value="frio">Frio County</option>
                            <option value="gaines">Gaines County</option>
                            <option value="galveston">Galveston County</option>
                            <option value="garza">Garza County</option>
                            <option value="gillespie">Gillespie County</option>
                            <option value="glasscock">Glasscock County</option>
                            <option value="goliad">Goliad County</option>
                            <option value="gonzales">Gonzales County</option>
                            <option value="gray">Gray County</option>
                            <option value="grayson">Grayson County</option>
                            <option value="gregg">Gregg County</option>
                            <option value="grimes">Grimes County</option>
                            <option value="guadalupe">Guadalupe County</option>
                            <option value="hale">Hale County</option>
                            <option value="hall">Hall County</option>
                            <option value="hamilton">Hamilton County</option>
                            <option value="hansford">Hansford County</option>
                            <option value="hardeman">Hardeman County</option>
                            <option value="hardin">Hardin County</option>
                            <option value="harris">Harris County</option>
                            <option value="harrison">Harrison County</option>
                            <option value="hartley">Hartley County</option>
                            <option value="haskell">Haskell County</option>
                            <option value="hays">Hays County</option>
                            <option value="hemphill">Hemphill County</option>
                            <option value="henderson">Henderson County</option>
                            <option value="hidalgo">Hidalgo County</option>
                            <option value="hill">Hill County</option>
                            <option value="hockley">Hockley County</option>
                            <option value="hood">Hood County</option>
                            <option value="hopkins">Hopkins County</option>
                            <option value="houston">Houston County</option>
                            <option value="howard">Howard County</option>
                            <option value="hudspeth">Hudspeth County</option>
                            <option value="hunt">Hunt County</option>
                            <option value="hutchinson">Hutchinson County</option>
                            <option value="irion">Irion County</option>
                            <option value="jack">Jack County</option>
                            <option value="jackson">Jackson County</option>
                            <option value="jasper">Jasper County</option>
                            <option value="jeff-davis">Jeff Davis County</option>
                            <option value="jefferson">Jefferson County</option>
                            <option value="johnson">Johnson County</option>
                            <option value="jones">Jones County</option>
                            <option value="karnes">Karnes County</option>
                            <option value="kaufman">Kaufman County</option>
                            <option value="kendall">Kendall County</option>
                            <option value="kenedy">Kenedy County</option>
                            <option value="kent">Kent County</option>
                            <option value="kerr">Kerr County</option>
                            <option value="kimble">Kimble County</option>
                            <option value="king">King County</option>
                            <option value="kinney">Kinney County</option>
                            <option value="kleberg">Kleberg County</option>
                            <option value="knox">Knox County</option>
                            <option value="la-salle">La Salle County</option>
                            <option value="lamar">Lamar County</option>
                            <option value="lamb">Lamb County</option>
                            <option value="lampasas">Lampasas County</option>
                            <option value="lavaca">Lavaca County</option>
                            <option value="lee">Lee County</option>
                            <option value="leon">Leon County</option>
                            <option value="liberty">Liberty County</option>
                            <option value="limestone">Limestone County</option>
                            <option value="lipscomb">Lipscomb County</option>
                            <option value="live-oak">Live Oak County</option>
                            <option value="llano">Llano County</option>
                            <option value="loving">Loving County</option>
                            <option value="lubbock">Lubbock County</option>
                            <option value="lynn">Lynn County</option>
                            <option value="madison">Madison County</option>
                            <option value="marion">Marion County</option>
                            <option value="martin">Martin County</option>
                            <option value="mason">Mason County</option>
                            <option value="matagorda">Matagorda County</option>
                            <option value="maverick">Maverick County</option>
                            <option value="mcculloch">McCulloch County</option>
                            <option value="mclennan">McLennan County</option>
                            <option value="mcmullen">McMullen County</option>
                            <option value="medina">Medina County</option>
                            <option value="menard">Menard County</option>
                            <option value="midland">Midland County</option>
                            <option value="milam">Milam County</option>
                            <option value="mills">Mills County</option>
                            <option value="mitchell">Mitchell County</option>
                            <option value="montague">Montague County</option>
                            <option value="montgomery">Montgomery County</option>
                            <option value="moore">Moore County</option>
                            <option value="morris">Morris County</option>
                            <option value="motley">Motley County</option>
                            <option value="nacogdoches">Nacogdoches County</option>
                            <option value="navarro">Navarro County</option>
                            <option value="newton">Newton County</option>
                            <option value="nolan">Nolan County</option>
                            <option value="nueces">Nueces County</option>
                            <option value="ochiltree">Ochiltree County</option>
                            <option value="oldham">Oldham County</option>
                            <option value="orange">Orange County</option>
                            <option value="palo-pinto">Palo Pinto County</option>
                            <option value="panola">Panola County</option>
                            <option value="parker">Parker County</option>
                            <option value="parmer">Parmer County</option>
                            <option value="pecos">Pecos County</option>
                            <option value="polk">Polk County</option>
                            <option value="potter">Potter County</option>
                            <option value="presidio">Presidio County</option>
                            <option value="rains">Rains County</option>
                            <option value="randall">Randall County</option>
                            <option value="reagan">Reagan County</option>
                            <option value="real">Real County</option>
                            <option value="red-river">Red River County</option>
                            <option value="reeves">Reeves County</option>
                            <option value="refugio">Refugio County</option>
                            <option value="roberts">Roberts County</option>
                            <option value="robertson">Robertson County</option>
                            <option value="rockwall">Rockwall County</option>
                            <option value="runnels">Runnels County</option>
                            <option value="rusk">Rusk County</option>
                            <option value="sabine">Sabine County</option>
                            <option value="san-augustine">San Augustine County</option>
                            <option value="san-jacinto">San Jacinto County</option>
                            <option value="san-patricio">San Patricio County</option>
                            <option value="san-saba">San Saba County</option>
                            <option value="schleicher">Schleicher County</option>
                            <option value="scurry">Scurry County</option>
                            <option value="shackelford">Shackelford County</option>
                            <option value="shelby">Shelby County</option>
                            <option value="sherman">Sherman County</option>
                            <option value="smith">Smith County</option>
                            <option value="somervell">Somervell County</option>
                            <option value="starr">Starr County</option>
                            <option value="stephens">Stephens County</option>
                            <option value="sterling">Sterling County</option>
                            <option value="stonewall">Stonewall County</option>
                            <option value="sutton">Sutton County</option>
                            <option value="swisher">Swisher County</option>
                            <option value="tarrant">Tarrant County</option>
                            <option value="taylor">Taylor County</option>
                            <option value="terrell">Terrell County</option>
                            <option value="terry">Terry County</option>
                            <option value="throckmorton">Throckmorton County</option>
                            <option value="titus">Titus County</option>
                            <option value="tom-green">Tom Green County</option>
                            <option value="travis">Travis County</option>
                            <option value="trinity">Trinity County</option>
                            <option value="tyler">Tyler County</option>
                            <option value="upshur">Upshur County</option>
                            <option value="upton">Upton County</option>
                            <option value="uvalde">Uvalde County</option>
                            <option value="val-verde">Val Verde County</option>
                            <option value="van-zandt">Van Zandt County</option>
                            <option value="victoria">Victoria County</option>
                            <option value="walker">Walker County</option>
                            <option value="waller">Waller County</option>
                            <option value="ward">Ward County</option>
                            <option value="washington">Washington County</option>
                            <option value="webb">Webb County</option>
                            <option value="wharton">Wharton County</option>
                            <option value="wheeler">Wheeler County</option>
                            <option value="wichita">Wichita County</option>
                            <option value="wilbarger">Wilbarger County</option>
                            <option value="willacy">Willacy County</option>
                            <option value="williamson">Williamson County</option>
                            <option value="wilson">Wilson County</option>
                            <option value="winkler">Winkler County</option>
                            <option value="wise">Wise County</option>
                            <option value="wood">Wood County</option>
                            <option value="yoakum">Yoakum County</option>
                            <option value="young">Young County</option>
                            <option value="zapata">Zapata County</option>
                            <option value="zavala">Zavala County</option>
                        </datalist>
                    </div>

                    <div class="input-group">
                        <label for="city">City</label>
                        <input type="text" id="city" list="city-list" placeholder="Type or select city..." autocomplete="off">
                        <datalist id="city-list">
                            <!-- Cities will be populated dynamically -->
                        </datalist>
                    </div>

                    <div class="input-group">
                        <label for="zip">ZIP Code</label>
                        <input type="text" id="zip" placeholder="75001" maxlength="5">
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn-location" onclick="useLocation()">
                        üìç Use My Location
                    </button>
                    <button class="btn-scan" onclick="scanTaxes()">
                        üîç Scan Taxes
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Scanning Texas tax databases...</p>
            </div>

            <div class="results-section" id="results">
                <h2 class="section-title">üí∞ Applicable Taxes</h2>
                <div class="tax-grid" id="taxGrid">
                    <!-- Tax cards will be populated here -->
                </div>

                <div class="export-section">
                    <h3>Export Tax Configuration</h3>
                    <p style="margin: 15px 0; color: #7f8c8d;">Download tax rates in your preferred format for POS configuration</p>
                    <button class="btn btn-primary" onclick="exportJSON()">Export as JSON</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">Export as CSV</button>
                </div>
            </div>

            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- Include configuration file (create config.js from config.example.js) -->
    <script src="config.js"></script>
    
    <!-- Database API Integration -->
    <script>
        // Override the existing functions to use the database API
        let counties = [];
        let currentTaxData = null;

        // Load counties from database
        async function loadCountiesFromDB() {
            try {
                const response = await fetch('/api/counties');
                counties = await response.json();
                populateCountyDropdown();
            } catch (error) {
                console.error('Error loading counties:', error);
                showStatus('Error loading counties from database', 'error');
            }
        }

        // Populate county dropdown with database data
        function populateCountyDropdown() {
            const datalist = document.getElementById('county-list');
            datalist.innerHTML = '';
            
            counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county.slug;
                option.textContent = county.name;
                datalist.appendChild(option);
            });
        }

        // Load cities for selected county
        async function loadCitiesForCounty(countySlug) {
            const county = counties.find(c => c.slug === countySlug);
            if (!county) return;

            try {
                const response = await fetch(`/api/counties/${county.id}/cities`);
                const cities = await response.json();
                populateCityDropdown(cities);
            } catch (error) {
                console.error('Error loading cities:', error);
                showStatus('Error loading cities from database', 'error');
            }
        }

        // Populate city dropdown
        function populateCityDropdown(cities) {
            const datalist = document.getElementById('city-list');
            datalist.innerHTML = '';
            
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.slug;
                option.textContent = city.name;
                datalist.appendChild(option);
            });
        }

        // Override the existing scanTaxes function to use database
        async function scanTaxes() {
            const countySlug = document.getElementById('county').value;
            const citySlug = document.getElementById('city').value;
            const zip = document.getElementById('zip').value;

            if (!countySlug) {
                showStatus('Please select a county', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const county = counties.find(c => c.slug === countySlug);
                if (!county) {
                    throw new Error('County not found');
                }

                let cityId = null;
                if (citySlug) {
                    const response = await fetch(`/api/counties/${county.id}/cities`);
                    const cities = await response.json();
                    const city = cities.find(c => c.slug === citySlug);
                    if (city) {
                        cityId = city.id;
                    }
                }

                // Get tax data from database
                const taxResponse = await fetch(`/api/taxes/${county.id}${cityId ? '/' + cityId : ''}`);
                const taxData = await taxResponse.json();

                currentTaxData = {
                    location: { county: countySlug, city: citySlug, zip },
                    taxes: taxData.taxes,
                    totalRate: taxData.totalRate,
                    scanDate: new Date().toISOString()
                };

                displayTaxes(currentTaxData);
                showStatus('Tax scan completed successfully!', 'success');
            } catch (error) {
                console.error('Error scanning taxes:', error);
                showStatus('Error scanning taxes. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update the county input handler
        document.addEventListener('DOMContentLoaded', function() {
            // Load counties when page loads
            loadCountiesFromDB();

            const countyInput = document.getElementById('county');
            const cityInput = document.getElementById('city');
            
            // Handle county input changes
            countyInput.addEventListener('input', function() {
                const countySlug = this.value.toLowerCase();
                
                // Clear city input
                cityInput.value = '';
                
                // Load cities for selected county
                if (countySlug) {
                    loadCitiesForCounty(countySlug);
                }
            });
            
            // Handle county selection from datalist
            countyInput.addEventListener('change', function() {
                // Trigger input event to load cities
                this.dispatchEvent(new Event('input'));
            });
        });

        // Update displayTaxes function to handle database format
        function displayTaxes(taxData) {
            const taxGrid = document.getElementById('taxGrid');
            taxGrid.innerHTML = '';

            taxData.taxes.forEach(tax => {
                const taxCard = document.createElement('div');
                taxCard.className = 'tax-card ' + tax.type;
                taxCard.innerHTML = `
                    <div class="tax-name">${tax.name}</div>
                    <div class="tax-rate">${tax.is_percentage ? tax.rate + '%' : '$' + tax.rate}</div>
                    <div class="tax-description">${tax.description || 'No description available'}</div>
                    <div class="tax-applies-to"><strong>Applies to:</strong> ${tax.applies_to || 'All taxable sales'}</div>
                `;
                taxGrid.appendChild(taxCard);
            });

            // Add total rate summary
            const summaryCard = document.createElement('div');
            summaryCard.className = 'tax-card';
            summaryCard.style.background = 'linear-gradient(135deg, #74b9ff, #0984e3)';
            summaryCard.style.color = 'white';
            summaryCard.innerHTML = `
                <div class="tax-name" style="color: white;">Total Combined Rate</div>
                <div class="tax-rate" style="color: white;">${(taxData.totalRate * 100).toFixed(2)}%</div>
                <div class="tax-description" style="color: white;">Combined percentage rate for standard sales tax</div>
                <div class="tax-applies-to" style="background: rgba(255,255,255,0.1); color: white;"><strong>Note:</strong> Fixed fees are additional</div>
            `;
            taxGrid.appendChild(summaryCard);

            document.getElementById('results').classList.add('show');
        }
    </script>
</body>
</html>
